import{s as c,g as l}from"./index-DrpMAtVn.js";class y{static async assignOrderToStore(e){const{orderId:r,storeId:i,assignedBy:t="system",mode:n="manual"}=e;try{console.log("ğŸ”„ Starting order assignment:",{orderId:r,storeId:i,mode:n});const{data:s,error:a}=await c.from("orders").select("id, order_code, order_status, main_store_name, assigned_store_id").eq("id",r).single();if(a||!s)throw new Error(`Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${a?.message||"Order not found"}`);const{data:o,error:g}=await c.from("stores").select("id, name, status").eq("id",i).single();if(g||!o)throw new Error(`Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${g?.message||"Store not found"}`);if(o.status!=="active")throw new Error(`Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù†Ø´Ø·: ${o.name}`);if(s.order_status==="delivered"||s.order_status==="returned")throw new Error(`Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­ÙˆÙŠÙ„ Ø·Ù„Ø¨ Ø¨Ø­Ø§Ù„Ø©: ${s.order_status}`);const{error:d}=await c.from("orders").update({assigned_store_id:i,assigned_store_name:o.name,order_status:"assigned",updated_at:new Date().toISOString(),assignment_metadata:{assigned_by:t,assignment_mode:n,assigned_at:new Date().toISOString(),previous_status:s.order_status}}).eq("id",r);if(d)throw new Error(`ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨: ${d.message}`);return console.log("âœ… Order assigned successfully:",{orderId:r,storeName:o.name,previousStatus:s.order_status}),{success:!0,message:`ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${s.order_code} Ø¥Ù„Ù‰ Ù…ØªØ¬Ø± "${o.name}" Ø¨Ù†Ø¬Ø§Ø­`,order_status:"assigned",store_name:o.name,assigned_at:new Date().toISOString()}}catch(s){const a=l(s,"Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…ØªØ¬Ø±");return console.error("âŒ Error in assignOrderToStore:",{error:a,orderId:r,storeId:i}),{success:!1,error:a}}}static async autoAssignOrders(e={}){const{orderId:r,returnReason:i,mode:t="all"}=e;try{console.log("ğŸ¤– Starting auto-assignment:",{orderId:r,mode:t,returnReason:i});const{data:n,error:s}=await c.from("stores").select("id, name, status").eq("status","active");if(s)throw new Error(`ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØ§Ø¬Ø±: ${s.message}`);if(!n||n.length===0)throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ§Ø¬Ø± Ù†Ø´Ø·Ø©");let a=c.from("orders").select("id, order_code, main_store_name, order_status, assigned_store_id");t==="single"&&r?a=a.eq("id",r):a=a.or("order_status.eq.pending,order_status.eq.processing");const{data:o,error:g}=await a;if(g)throw new Error(`ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${g.message}`);if(!o||o.length===0)return{success:!0,message:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",assigned_count:0,unmatched_count:0,error_count:0,results:[]};const d=[];let f=0,h=0,_=0;for(const u of o)try{const m=n.find(p=>p.name.toLowerCase().trim()===u.main_store_name?.toLowerCase().trim());if(!m){h++,d.push({order_id:u.id,status:"unmatched",error_message:`Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¬Ø± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù€ "${u.main_store_name}"`});continue}const w=await this.assignOrderToStore({orderId:u.id,storeId:m.id,assignedBy:"auto-system",mode:"auto"});w.success?(f++,d.push({order_id:u.id,status:"assigned",store_name:m.name})):(_++,d.push({order_id:u.id,status:"error",error_message:w.error||"Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}))}catch(m){_++,d.push({order_id:u.id,status:"error",error_message:l(m,"Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ù„Ø¨")})}return console.log("âœ… Auto-assignment completed:",{total:o.length,assigned:f,unmatched:h,errors:_}),{success:!0,message:`ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${o.length} Ø·Ù„Ø¨: ${f} Ù…Ø­ÙˆÙ„ØŒ ${h} ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ØŒ ${_} Ø®Ø·Ø£`,assigned_count:f,unmatched_count:h,error_count:_,results:d}}catch(n){const s=l(n,"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª");return console.error("âŒ Error in autoAssignOrders:",{error:s,request:e}),{success:!1,error:s,assigned_count:0,unmatched_count:0,error_count:1}}}static async unassignOrder(e){try{const{error:r}=await c.from("orders").update({assigned_store_id:null,assigned_store_name:null,order_status:"pending",updated_at:new Date().toISOString()}).eq("id",e);if(r)throw new Error(`ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${r.message}`);return{success:!0,message:"ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­",order_status:"pending"}}catch(r){return{success:!1,error:l(r,"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ")}}}static async getAssignmentStats(){try{const{data:e,error:r}=await c.from("orders").select("order_status, assigned_store_id, main_store_name");if(r)throw r;return{success:!0,stats:{total:e.length,assigned:e.filter(t=>t.assigned_store_id).length,pending:e.filter(t=>t.order_status==="pending").length,processing:e.filter(t=>t.order_status==="processing").length,delivered:e.filter(t=>t.order_status==="delivered").length,returned:e.filter(t=>t.order_status==="returned").length}}}catch(e){return{success:!1,error:l(e,"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ")}}}}export{y as OrderAssignmentService,y as default};
