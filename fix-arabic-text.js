#!/usr/bin/env node

/**
 * Comprehensive Arabic text corruption fix tool
 * This script fixes all the � corruption in Arabic text files
 */

const fs = require('fs');
const path = require('path');

// Comprehensive mapping of corrupted text to fixed text
const CORRUPTION_FIXES = {
  // Single corruption patterns
  '��': '',
  '�': '',
  
  // Common Arabic word corruptions
  'ت��يين': 'تعيين',
  'الت��يين': 'التعيين',
  'التعي��ن': 'التعيين',
  'ط��ب': 'طلب',
  'طل��': 'طلب',
  'التل��ائي': 'التلقائي',
  'الت��قائي': 'التلقائي',
  'التلقا��ي': 'التلقائي',
  'التلقائ��': 'التلقائي',
  'المحسن��': 'المحسن',
  'النت��ئج': 'النتائج',
  'الن��ائج': 'النتائج',
  'النتا��ج': 'النتائج',
  'م��': 'من',
  'من': 'من',
  'بنج����ح': 'بنجاح',
  'بنج��ح': 'بنجاح',
  'بنجا��': 'بنجاح',
  '��رض': 'عرض',
  'عر��': 'عرض',
  'ف��': 'في',
  'في': 'في',
  '��ن': 'عن',
  'عن': 'عن',
  'ع��د': 'عدد',
  'عد��': 'عدد',
  'ي��كن': 'يمكن',
  'يمك��': 'يمكن',
  'تلقائي��اً': 'تلقائياً',
  'تلقائ��اً': 'تلقائياً',
  'تلقائيا��': 'تلقائياً',
  'الح��لات': 'الحالات',
  'الحا��ات': 'الحالات',
  'الحالا��': 'الحالات',
  '��لطلب': 'الطلب',
  'ال��طلب': 'الطلب',
  'الطل��': 'الطلب',
  'البح��': 'البحث',
  'البحث': 'البحث',
  'بالس��رفر': 'بالسرفر',
  'بالسرف��': 'بالسرفر',
  'الت��حميل': 'التحميل',
  'تح��يل': 'تحميل',
  'تحمي��': 'تحميل',
  'جا��ي': 'جاري',
  'جار��': 'جاري',
  'جاري': 'جاري',
  'البي��نات': 'البيانات',
  'البيا��ات': 'البيانات',
  'البيانا��': 'البيانات',
  'المط��ر': 'المطور',
  'المطو��': 'المطور',
  'المطور': 'المطور',
  'رد��د': 'ردود',
  'ردو��': 'ردود',
  'معلوم��ت': 'معلومات',
  'معلو��ات': 'معلومات',
  'مع��ومات': 'معلومات',
  'معلوما��': 'معلومات',
  'مختص��ة': 'مختصرة',
  'مختصر��': 'مختصرة',
  'المع��لقة': 'المعلقة',
  'المعل��ة': 'المعلقة',
  'المعلق��': 'المعلقة',
  'سر��ع': 'سريع',
  'سري��': 'سريع',
  'سريع': 'سريع',
  'جم��ع': 'جميع',
  'جمي��': 'جميع',
  'جميع': 'جميع',
  'المنا��بة': 'المناسبة',
  'المناس��ة': 'المناسبة',
  'المناسب��': 'المناسبة',
  'تل��ائي': 'تلقائي',
  'تلق��ئي': 'تلقائي',
  'تلقائي': 'تلقائي',
  'الأص��ي': 'الأصلي',
  'الأصل��': 'الأصلي',
  'الأصلي': 'الأصلي',
  '��فرت': 'وفرت',
  'وف��ت': 'وفرت',
  'وفرت': 'وفرت',
  'السع��': 'السعر',
  'السعر': 'السعر',
  'غ��ر': 'غير',
  'غي��': 'غير',
  'غير': 'غير',
  'مت��حة': 'متاحة',
  'متا��ة': 'متاحة',
  'متاحة': 'متاحة',
  'تفاص��ل': 'تفاصيل',
  'تفاصي��': 'تفاصيل',
  'تفاصيل': 'تفاصيل',
  'المنتج��ت': 'المنتجات',
  'المنتجا��': 'المنتجات',
  'المنتجات': 'المنتجات',
  'منت��ات': 'منتجات',
  'منتجا��': 'منتجات',
  'انق��': 'انقر',
  'انقر': 'انقر',
  'نا��ذة': 'نافذة',
  'نافذ��': 'نافذة',
  'نافذة': 'نافذة',
  'الكامل��': 'الكاملة',
  'الكام��ة': 'الكاملة',
  'الكاملة': 'الكاملة',
  'اخت��': 'اختر',
  'اختر': 'اختر',
  'متج��': 'متجر',
  'متجر': 'متجر',
  'إنش��ء': 'إنشاء',
  'إنشا��': 'إنشاء',
  'إنشاء': 'إنشاء',
  'مرف��ض': 'مرفوض',
  'مرفو��': 'مرفوض',
  'مرفوض': 'مرفوض',
  'التق��يم': 'التقسيم',
  'التقسي��': 'التقسيم',
  'التقسيم': 'التقسيم',
  'المخ��ون': 'المخزون',
  'المخزو��': 'المخزون',
  'المخزون': 'المخز��ن',
  'المتج��': 'المتجر',
  'المتجر': 'المتجر',
  'التح��يل': 'التحويل',
  'التحو��ل': 'التحويل',
  'التحويل': 'التحويل',
  'ت��ويل': 'تحويل',
  'تحوي��': 'تحويل',
  'التغيي��': 'التغيير',
  'التغي��ر': 'التغيير',
  'التغيير': 'التغيير',
  'التوف��': 'التوفر',
  'التوفر': 'التوفر',
  'الهات��': 'الهاتف',
  'الها��ف': 'الهاتف',
  'الهاتف': 'الهاتف',
  'ملاحظ��ت': 'ملاحظات',
  'ملاح��ات': 'ملاحظات',
  'م��اح��ات': 'ملاحظات',
  'ملاحظات': 'ملاحظات',
  'حال��': 'حالة',
  'حا��ة': 'حالة',
  'ح��لة': 'حالة',
  'حالة': 'حالة',
  'منتج��ت': 'منتجات',
  'منتجا��': 'منتجات',
  'منتجات': 'منتجات',
  'إضاف��': 'إضافي',
  'إضا��ي': 'إضافي',
  'إضافي': 'إضافي',
  
  // Special phrases
  'اسم ��لعميل': 'اسم العميل',
  'الها��ف': 'الهاتف',
  '��الة غير معروفة': 'حالة غير معروفة',
  'ق��د الانتظار': 'قيد الانتظار',
  'للحا��ات': 'للحالات',
  'ا��إحصائيات': 'الإحصائيات',
  'ع��د الطلبات': 'عدد الطلبات',
  'ي��كن تحويلها': 'يمكن تحويلها',
  'تلقائ��اً': 'تلقائياً',
  'بعد التقسي��': 'بعد التقسيم',
  'خطأ ف�� ���رض': 'خطأ في عرض',
  'معلوم����ت مخت��رة': 'معلومات مختصرة',
  'معلوم����ت مختصرة': 'معلومات مختصرة',
  'منت��ات الطلب': 'منتجات الطلب',
  'السعر الأص��ي': 'السعر الأصلي',
  '��فرت': 'وفرت',
  'السع��': 'السعر',
  'تفاصيل المنتجات ��ير مت��حة': 'تفاصيل المنتجات غير متاحة',
  'انق�� على زر': 'انقر على زر',
  'لفت�� ��افذة': 'لفتح نافذة',
  'التفاصي�� الكاملة': 'التفاصيل الكاملة',
  'جاري تح��يل الب��انات': 'جاري تحميل البيانات',
  'وحدة تحكم المط��ر': 'وحدة تحكم المطور',
  'إشعارات ��د��د': 'إشعارات ردود',
  'جار�� إنشاء': 'جاري إنشاء',
  'إنشاء ا��متجر': 'إنشاء المتجر',
  '����': 'مرفوض',
  'رفض الزبون': 'رفض الزبون',
  'تحويل ��ريع': 'تحويل سريع',
  'ا��معلقة': 'المعلقة',
  'ج��يع الطلبات': 'جميع الطلبات',
  'ال��علقة': 'المعلقة',
  'تلقائي���ً': 'تلقائياً',
  'المنا��بة': 'المناسبة',
  'تحويل ت��قائي': 'تحويل تلقائي',
  'جاري تح��يل الطلبات': 'جاري تحميل الطلبات',
  
  // Corrupted notifications text
  'دالة للتحقق من وجود جدول الإشع��رات': 'دالة للتحقق من وجود جدول الإشعارات',
  '��جد': 'وجد',
  'اخ��بار تدفق': 'اختبار تدفق',
  'بنجاح': 'بنجاح',
  '��نجاح': 'بنجاح',
  'نجح الا��تبار': 'نجح الاختبار',
  'أنماط أسماء المنت��ات': 'أنماط أسماء المنتجات',
  'بيانات تجريبية جا��زة': 'بيانات تجريبية جاهزة',
  'عدم استهل��ك': 'عدم استهلاك',
  'خطأ في جلب تفاصي��': 'خطأ في جلب تفاصيل',
  'متجر مط��بق': 'متجر مطابق',
  
  // Console text
  '���� تص��ية': 'جاري تصفية',
  'بالس��رفر للتعيين': 'بالسرفر للتعيين',
  'فشل ا��تعيين': 'فشل التعيين',
  'التلقائ���': 'التلقائي',
  'حدث خ��أ غي�� مت��قع': 'حدث خطأ غير متوقع',
  'البحث ��ن المتجر': 'البحث عن المتجر',
  '��اسم المتجر': 'باسم المتجر',
  '��لتحويل': 'التحويل',
  '��لمتجر المناسب': 'المتجر المناسب'
};

function fixArabicCorruption(content) {
  let fixedContent = content;
  
  // Apply all fixes
  for (const [corrupted, fixed] of Object.entries(CORRUPTION_FIXES)) {
    const regex = new RegExp(corrupted.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    fixedContent = fixedContent.replace(regex, fixed);
  }
  
  return fixedContent;
}

function processFile(filePath) {
  try {
    const content = fs.readFileSync(filePath, 'utf8');
    const fixedContent = fixArabicCorruption(content);
    
    if (content !== fixedContent) {
      fs.writeFileSync(filePath, fixedContent, 'utf8');
      console.log(`✅ Fixed: ${filePath}`);
      return true;
    }
    
    return false;
  } catch (error) {
    console.error(`❌ Error processing ${filePath}:`, error.message);
    return false;
  }
}

function main() {
  console.log('🔧 Starting Arabic text corruption fix...');
  
  const targetFiles = [
    'code/src/pages/AdminDashboard.tsx',
    'code/src/contexts/LanguageContext.tsx',
    'code/src/utils/arabicTextUtils.ts',
    'code/src/utils/notificationDbChecker.ts',
    'code/src/utils/fixStoreNames.ts',
    'code/src/utils/testStoreResponseFlow.ts',
    'code/src/utils/runNotificationsMigration.ts',
    'code/src/utils/testOrderSystem.ts',
    'code/src/utils/databaseFix.ts',
    'code/src/utils/productNameFixer.tsx',
    'code/src/utils/createTestDivisions.ts',
    'code/src/hooks/useOrderDivisions.ts',
    'code/src/hooks/useEnhancedEdgeFunctions.ts'
  ];
  
  let fixedCount = 0;
  
  for (const filePath of targetFiles) {
    if (fs.existsSync(filePath)) {
      if (processFile(filePath)) {
        fixedCount++;
      }
    } else {
      console.warn(`⚠️  File not found: ${filePath}`);
    }
  }
  
  console.log(`\n✅ Completed! Fixed ${fixedCount} files.`);
}

if (require.main === module) {
  main();
}

module.exports = { fixArabicCorruption, CORRUPTION_FIXES };
